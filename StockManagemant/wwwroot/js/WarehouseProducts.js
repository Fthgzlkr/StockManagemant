  $(document).ready(function () {
            let warehouseId;
            
      
            
            if (userRole === "BasicUser") {
                warehouseId = assignedWarehouseId;
                localStorage.setItem("selectedWarehouseId", warehouseId);
            } else {
                warehouseId = localStorage.getItem("selectedWarehouseId") || 1;
            }
            
            // Stok deƒüi≈üimlerini izleyen nesne
            let stockChanges = {};
                
            let currencyDropdown = { "TL": "T√ºrk Lirasƒ±", "USD": "Dolar" };

       // jqGrid Ba≈ülat
       $("#warehouseProductGrid").jqGrid({
           url: `/WarehouseProduct/GetWarehouseProducts?warehouseId=${warehouseId}`,
           datatype: "json",
           mtype: "GET",
           colNames: ['ID','ProductId', 'Barkod','Stok Kodu','√úr√ºn Adƒ±', 'Kategori', 'Fiyat', 'Para Birimi', 'Stok', ' Depo Lokasyonu', 'ƒ∞≈ülemler'],
           colModel: [
               { name: 'id', index: 'id', align: "center", sortable: true, key: true, hidden: true },
               { name: 'product_id', index: 'product_id', align: "center", sortable: true, key: true, hidden:true },
               { name: 'barcode', index: 'barcode', align: "center", sortable: true, hidden:false },
               { name: 'stockcode', index: ' stockcode', align: "center", sortable: true, hidden:false },
               { name: 'name', index: 'name', sortable: true, editable: false },
               { name: 'category', index: 'category', sortable: true, editable: false },
               { name: 'price', index: 'price', align: "center", sortable: true, editable: false, formatter: formatPrice },
               { name: 'currencyType', index: 'currencyType', sortable: true, editable: false, formatter: currencyFormatter ,hidden:true},
               { 
                   name: 'stock', 
                   index: 'stock', 
                   align: "center", 
                   sortable: true, 
                   editable: false, 
                   formatter: function (cellvalue, options, rowObject) {
                       return `
                           <div class="stock-container" style="display: flex; align-items: center; justify-content: center;">
                               <input type="number" class="stock-input" 
                                   data-id="${rowObject.id}"
                                   data-product-name="${rowObject.name}"
                                   data-stockcode="${rowObject.stockcode}"
                                   data-barcode="${rowObject.barcode}"
                                   value="${cellvalue}"
                                   data-original-value="${cellvalue}"
                                   readonly
                                   style="width: 70px; height: 25px; text-align: center; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; cursor: pointer;">
                               <div class="stock-controls" style="display: flex; flex-direction: column; margin-left: 3px;">
                                   <button class="increaseStockBtn" data-id="${rowObject.id}" data-product-name="${rowObject.name}" data-stockcode="${rowObject.stockcode}" data-barcode="${rowObject.barcode}" title="Stok Artƒ±r"
                                       style="border: none; background: transparent; cursor: pointer; font-size: 10px; padding: 2px;">
                                       ‚ñ≤
                                   </button>
                                   <button class="decreaseStockBtn" data-id="${rowObject.id}" data-product-name="${rowObject.name}" data-stockcode="${rowObject.stockcode}" data-barcode="${rowObject.barcode}" title="Stok Azalt"
                                       style="border: none; background: transparent; cursor: pointer; font-size: 10px; padding: 2px;">
                                       ‚ñº
                                   </button>
                               </div>
                           </div>
                       `;
                   }
               },
               {
                   name: 'location',
                   index: 'location',
                   align: "center",
                   sortable: false,
                   formatter: function (cellvalue) {
                       return cellvalue ? cellvalue : `<span class="text-muted">Lokasyon Yok</span>`;
                   }
               },
               {
                   name: "actions",
                   label: "ƒ∞≈ülemler",
                   align: "center",
                   formatter: function (cellvalue, options, rowObject) {
                       return `
                           <div class="action-icons">                            
                               <i class="fa-solid fa-trash text-danger fa-xl deleteWarehouseProductBtn"
                                   data-id="${rowObject.id}" title="Depodan Kaldƒ±r"></i>
                           </div>
                       `;
                   }
               }
           ],
           pager: '#pager',
           rowNum: 5,
           rowList: [5, 10, 15, 20, 30, 40, 50],
           sortname: 'id',
           sortorder: 'asc',
           viewrecords: true,
           height: 'auto',
           autowidth: true,
           shrinkToFit: true,
           caption: "Depodaki √úr√ºnler",
           loadonce: false,
           guiStyle: "bootstrap4",
           jsonReader: {
               root: "rows",
               page: "page",
               total: "total",
               records: "records"
           },

             ondblClickRow: function (rowid) {
                if (rowid) {
                    const rowData = $("#warehouseProductGrid").jqGrid("getRowData", rowid);
                    const productId = rowData.product_id;
                    window.open('/Product/ProductDetail/' + productId, '_blank');
                }
            },

          
           rowattr: function (rowObject) {
               if (rowObject.stock < 15) {
                   return { "class": "low-stock-row" };
               }
           },
       });
           
       $("<style>")
        .prop("type", "text/css")
        .html(`
            .low-stock-row td {
                background-color: #ffcccc !important;
            }
        `)
        .appendTo("head");

        
        function currencyFormatter(cellValue, options, rowObject) {
            return currencyDropdown[cellValue] || cellValue;
        }

      
        function formatPrice(cellValue, options, rowObject) {
            if (!cellValue) return "0.00";
            let currencySymbol = rowObject.currencyType === "TL" ? "‚Ç∫" : "$";
            return cellValue.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + " " + currencySymbol;
        }

        
        function filterWarehouseProducts() {
            let searchName = $("#productSearch").val().trim();
            let minPrice = $("#minPrice").val();
            let maxPrice = $("#maxPrice").val();
            let StockCode = $("#stockCodeSearch").val().trim();

            $("#warehouseProductGrid").jqGrid('setGridParam', {
                url: `/WarehouseProduct/GetWarehouseProducts?warehouseId=${warehouseId}&search=${searchName}&minPrice=${minPrice}&maxPrice=${maxPrice}&stockCode=${StockCode}`,
                page: 1
            }).trigger("reloadGrid");
        }

        
        $("#filterBtn").on("click", function () {
            filterWarehouseProducts();
        });

  

// ‚ûï Artƒ±rma
$(document).on("click", ".increaseStockBtn", function () {
    let warehouseProductId = $(this).data("id");
    let productName = $(this).data("product-name");
    let stockCode = $(this).data("stockcode");
    let barcode = $(this).data("barcode");
    let input = $(`input.stock-input[data-id="${warehouseProductId}"]`);
    let current = parseInt(input.val());
    let originalValue = current;

    updateStock(warehouseProductId, current + 1, productName, stockCode, barcode, originalValue);
});

// ‚ûñ Azaltma
$(document).on("click", ".decreaseStockBtn", function () {
    let warehouseProductId = $(this).data("id");
    let productName = $(this).data("product-name");
    let stockCode = $(this).data("stockcode");
    let barcode = $(this).data("barcode");
    let input = $(`input.stock-input[data-id="${warehouseProductId}"]`);
    let current = parseInt(input.val());
    let originalValue = current;

    if (current > 0) updateStock(warehouseProductId, current - 1, productName, stockCode, barcode, originalValue);
});

// üñ±Ô∏è Stok sayƒ±sƒ±na tƒ±klayƒ±nca input aktifle≈üsin
$(document).on("click", ".stock-input", function () {
    $(this).data("original-value", $(this).val());
    $(this).removeAttr("readonly");

    setTimeout(() => {
        $(this).focus().select();
    }, 0);
});

// üñäÔ∏è Kullanƒ±cƒ± inputtan √ßƒ±karsa veya Enter'a basarsa yeni deƒüer g√∂nder
$(document).on("blur", ".stock-input", function () {
    let input = $(this);
    let warehouseProductId = input.data("id");
    let productName = input.data("product-name");
    let stockCode = input.data("stockcode");
    let barcode = input.data("barcode");
    let newValue = parseInt(input.val());
    let originalValue = parseInt(input.data("original-value"));

    if (!isNaN(newValue)) updateStock(warehouseProductId, newValue, productName, stockCode, barcode, originalValue);
});

$(document).on("keypress", ".stock-input", function (e) {
    if (e.which === 13) {
        $(this).blur(); 
    }
});

function updateStock(warehouseProductId, newStock, productName, stockCode, barcode, originalValue) {
    // Orijinal deƒüer hala tanƒ±msƒ±zsa, grid'den alƒ±yoruz
    if (originalValue === undefined) {
        originalValue = parseInt($(`input.stock-input[data-id="${warehouseProductId}"]`).data("original-value"));
        
        if (isNaN(originalValue)) {
            originalValue = parseInt($(`input.stock-input[data-id="${warehouseProductId}"]`).val());
        }
    }

    // ‚ùó Sunucuya stok g√ºncellemesi yapmayƒ± kaldƒ±rƒ±yoruz. Sadece UI √ºst√ºnden deƒüi≈üim g√∂steriyoruz.
    $(`input.stock-input[data-id="${warehouseProductId}"]`).val(newStock);

    // Stok deƒüi≈üimini kaydet (fi≈ü olu≈üturulacak deƒüi≈üiklikleri i≈ülemek i√ßin)
    trackStockChange(warehouseProductId, originalValue, newStock, productName, stockCode, barcode);
}

// Stok deƒüi≈üimlerini izleme fonksiyonu (g√ºncellenmi≈ü: fiyat dahil)
function trackStockChange(warehouseProductId, oldStock, newStock, productName, stockCode, barcode) {
    const difference = newStock - oldStock;
    if (difference === 0) return;

    // Grid'in verisini al
    const gridData = $("#warehouseProductGrid").jqGrid("getGridParam", "data");
    let productPrice = 0;
    let productId = null;

    // ID'ye g√∂re depo √ºr√ºn√ºn√º bul ve product_id'yi √ßek
    if (gridData && gridData.length > 0) {
        const productRow = gridData.find(row => String(row.id) === String(warehouseProductId));
        if (productRow) {
            productPrice = productRow.price;
            productId = productRow.product_id; // ‚≠êÔ∏è Burada product_id alƒ±yoruz
        }
    }

    if (!productPrice) {
        $.ajax({
            url: `/WarehouseProduct/GetWarehouseProducts?warehouseId=${warehouseId}`,
            type: 'GET',
            async: false,
            success: function(response) {
                if (response && response.rows) {
                    const product = response.rows.find(item => String(item.id) === String(warehouseProductId));
                    if (product) {
                        productPrice = product.price;
                        productId = product.product_id;
                    }
                }
            }
        });
    }

    if (!productId) {
        console.error("√úr√ºn√ºn ProductId bilgisi bulunamadƒ±!");
        return;
    }

    if (stockChanges[productId]) {
        stockChanges[productId].quantity += difference;
        if (stockChanges[productId].quantity === 0) {
            delete stockChanges[productId];
        }
    } else {
        stockChanges[productId] = {
            id: productId,  // ‚úÖ Artƒ±k productId g√∂nderiyoruz
            productName: productName,
            quantity: difference,
            price: productPrice,
        };
    }

    updateReceiptPreview();
}

// Fi≈ü √∂nizlemelerini g√ºncelleme fonksiyonu
function updateReceiptPreview() {
    // Giri≈ü ve √ßƒ±kƒ±≈ü listelerini temizle
    $("#inputReceiptList").empty();
    $("#outputReceiptList").empty();
    
    let hasInputs = false;
    let hasOutputs = false;
    
    // T√ºm stok deƒüi≈üimlerini dola≈ü
    Object.values(stockChanges).forEach(item => {
        if (item.quantity > 0) {
            // Giri≈ü fi≈üine ekle
            $("#inputReceiptList").append(`
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.productName}</strong>
                        <small class="d-block text-muted">Barkod: ${item.barcode || 'Yok'} | Stok Kodu: ${item.stockCode || 'Yok'}</small>
                    </div>
                    <span class="badge bg-success rounded-pill px-3 py-2 fs-6">+${item.quantity}</span>
                </li>
            `);
            hasInputs = true;
        } else if (item.quantity < 0) {
            // √áƒ±kƒ±≈ü fi≈üine ekle
            $("#outputReceiptList").append(`
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.productName}</strong>
                        <small class="d-block text-muted">Barkod: ${item.barcode || 'Yok'} | Stok Kodu: ${item.stockCode || 'Yok'}</small>
                    </div>
                    <span class="badge bg-danger rounded-pill px-3 py-2 fs-6">${item.quantity}</span>
                </li>
            `);
            hasOutputs = true;
        }
    });
    
    // Kartlarƒ±n g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
    if (hasInputs) {
        $("#inputReceiptCard").removeClass("d-none");
    } else {
        $("#inputReceiptCard").addClass("d-none");
    }
    
    if (hasOutputs) {
        $("#outputReceiptCard").removeClass("d-none");
    } else {
        $("#outputReceiptCard").addClass("d-none");
    }
    
    // Tamamlama butonunun ve a√ßƒ±klama alanlarƒ±nƒ±n g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
    if (hasInputs || hasOutputs) {
        $("#completeReceiptsBtn").removeClass("d-none");
        if (hasInputs) {
            $("#entryDescriptionContainer").removeClass("d-none");
        } else {
            $("#entryDescriptionContainer").addClass("d-none");
        }
        if (hasOutputs) {
            $("#exitDescriptionContainer").removeClass("d-none");
        } else {
            $("#exitDescriptionContainer").addClass("d-none");
        }
    } else {
        $("#completeReceiptsBtn").addClass("d-none");
        $("#entryDescriptionContainer").addClass("d-none");
        $("#exitDescriptionContainer").addClass("d-none");
    }
}

// Fi≈üleri tamamlama fonksiyonu (Y√∂ntem 1: Ayrƒ± JSON istekleri)
$("#completeReceiptsBtn").on("click", function() {
    // A√ßƒ±klama alanlarƒ±ndan deƒüerleri al
    const entryDescription = $("#entryDescription").val().trim();
    const exitDescription = $("#exitDescription").val().trim();

    // Giri≈ü ve √ßƒ±kƒ±≈ü deƒüi≈üikliklerini ayƒ±r
    const entryChanges = Object.values(stockChanges).filter(item => item.quantity > 0);
    const exitChanges = Object.values(stockChanges).filter(item => item.quantity < 0);

    // G√∂nderilecek istekler
    let requests = [];

    if (entryChanges.length > 0) {
        requests.push(
            $.ajax({
                url: '/Receipt/SaveEntryReceipt',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    warehouseId: warehouseId,
                    description: entryDescription,
                    changes: entryChanges
                })
            })
        );
    }
    if (exitChanges.length > 0) {
        requests.push(
            $.ajax({
                url: '/Receipt/SaveExitReceipt',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    warehouseId: warehouseId,
                    description: exitDescription,
                    changes: exitChanges
                })
            })
        );
    }

    // T√ºm istekler tamamlanƒ±nca
    $.when.apply($, requests)
        .done(function() {
            Swal.fire({
                title: "Ba≈üarƒ±lƒ±!",
                text: "Stok deƒüi≈üimleri kaydedildi.",
                icon: "success"
            });
            // Deƒüi≈üimleri ve a√ßƒ±klama alanƒ±nƒ± temizle
            stockChanges = {};
            $("#entryDescription").val("");
            $("#exitDescription").val("");
            updateReceiptPreview();
        })
        .fail(function() {
            Swal.fire({
                title: "Hata!",
                text: "Stok deƒüi≈üimleri kaydedilirken bir hata olu≈ütu.",
                icon: "error"
            });
        });
});


        // Depodan √úr√ºn√º Kaldƒ±rma Butonu
        $(document).on("click", ".deleteWarehouseProductBtn", function () {
            let id = $(this).data("id");

            Swal.fire({
                title: "√úr√ºn√º Depodan Kaldƒ±r",
                text: "Bu √ºr√ºn√º depodan √ßƒ±karmak istediƒüinize emin misiniz?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Evet, Kaldƒ±r!",
                cancelButtonText: "ƒ∞ptal"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/WarehouseProduct/RemoveProductFromWarehouse',
                        type: 'POST',
                        data: { warehouseProductId: id },
                        success: function (response) {
                            Swal.fire("Ba≈üarƒ±lƒ±!", "√úr√ºn depodan kaldƒ±rƒ±ldƒ±.", "success");
                            $("#warehouseProductGrid").trigger("reloadGrid");
                        },
                        error: function () {
                            Swal.fire("Hata!", "√úr√ºn kaldƒ±rƒ±lƒ±rken hata olu≈ütu.", "error");
                        }
                    });
                }
            });
        });

            $(document).on("click", ".ƒ∞ncreaseStockBtn", function () {
        let productId = $(this).data("id");
        updateStock(productId, 1);
    });


    

        $("#pager_left").append(`
            <i id="customRefreshBtn" class="fa-solid fa-arrows-rotate" title="Yenile" style="cursor: pointer; margin-left: 10px;"></i>
        `);

                    $("#pager_left").append(`
        <i class="fa-solid fa-plus fa-2xl openProductaddModal" title="Yeni √úr√ºn Ekle" style="cursor: pointer; margin-left: 10px;"></i>
    `);

            
        $("#customRefreshBtn").on("click", function () {
            $("#productSearch").val("");
            $("#minPrice").val("");
            $("#maxPrice").val("");
            $("#warehouseProductGrid").setGridParam({
                url: `/WarehouseProduct/GetWarehouseProducts?warehouseId=${warehouseId}`,
                page: 1
            }).trigger("reloadGrid");
        });

    });

